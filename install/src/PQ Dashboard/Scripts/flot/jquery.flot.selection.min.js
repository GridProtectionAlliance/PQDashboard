(function(a){function b(p){var t={first:{x:-1,y:-1},second:{x:-1,y:-1},show:false,active:false,suspended:false};var q={};var o=null;function j(u){if(t.active){m(u);p.getPlaceholder().trigger("plotselecting",[g()])}}function i(u){if(u.which!=1){return}document.body.focus();if(document.onselectstart!==undefined&&q.onselectstart==null){q.onselectstart=document.onselectstart;document.onselectstart=function(){return false}}if(document.ondrag!==undefined&&q.ondrag==null){q.ondrag=document.ondrag;document.ondrag=function(){return false}}r(t.first,u);t.active=!t.suspended;o=function(v){e(v)};a(document).one("mouseup",o)}function e(u){o=null;if(document.onselectstart!==undefined){document.onselectstart=q.onselectstart}if(document.ondrag!==undefined){document.ondrag=q.ondrag}t.active=false;m(u);if(s()){c()}else{p.getPlaceholder().trigger("plotunselected",[]);p.getPlaceholder().trigger("plotselecting",[null])}return false}function g(){if(!s()){return null}if(!t.show){return null}var w={},v=t.first,u=t.second;a.each(p.getAxes(),function(x,y){if(y.used){var A=y.c2p(v[y.direction]),z=y.c2p(u[y.direction]);w[x]={from:Math.min(A,z),to:Math.max(A,z)}}});return w}function c(){var u=g();p.getPlaceholder().trigger("plotselected",[u]);if(u.xaxis&&u.yaxis){p.getPlaceholder().trigger("selected",[{x1:u.xaxis.from,y1:u.yaxis.from,x2:u.xaxis.to,y2:u.yaxis.to}])}}function k(v,w,u){return w<v?v:(w>u?u:w)}function r(y,v){var x=p.getOptions();var w=p.getPlaceholder().offset();var u=p.getPlotOffset();y.x=k(0,v.pageX-w.left-u.left,p.width());y.y=k(0,v.pageY-w.top-u.top,p.height());if(x.selection.mode=="y"){y.x=y==t.first?0:p.width()}if(x.selection.mode=="x"){y.y=y==t.first?0:p.height()}}function m(u){if(u.pageX==null){return}r(t.second,u);if(s()){t.show=true;p.triggerRedrawOverlay()}else{n(true)}}function n(u){if(t.show){t.show=false;p.triggerRedrawOverlay();if(!u){p.getPlaceholder().trigger("plotunselected",[])}}}function f(u,y){var v,A,B,C,z=p.getAxes();for(var w in z){v=z[w];if(v.direction==y){C=y+v.n+"axis";if(!u[C]&&v.n==1){C=y+"axis"}if(u[C]){A=u[C].from;B=u[C].to;break}}}if(!u[C]){v=y=="x"?p.getXAxes()[0]:p.getYAxes()[0];A=u[y+"1"];B=u[y+"2"]}if(A!=null&&B!=null&&A>B){var x=A;A=B;B=x}return{from:A,to:B,axis:v}}function h(v,u){var x,w,y=p.getOptions();if(y.selection.mode=="y"){t.first.x=0;t.second.x=p.width()}else{w=f(v,"x");t.first.x=w.axis.p2c(w.from);t.second.x=w.axis.p2c(w.to)}if(y.selection.mode=="x"){t.first.y=0;t.second.y=p.height()}else{w=f(v,"y");t.first.y=w.axis.p2c(w.from);t.second.y=w.axis.p2c(w.to)}t.show=true;p.triggerRedrawOverlay();if(!u&&s()){c()}}function s(){var u=p.getOptions().selection.minSize;return Math.abs(t.second.x-t.first.x)>=u&&Math.abs(t.second.y-t.first.y)>=u}function d(){t.active=false;t.suspended=true;if(o){a(document).unbind("mouseup",o);if(document.onselectstart!==undefined){document.onselectstart=q.onselectstart}if(document.ondrag!==undefined){document.ondrag=q.ondrag}}}function l(){t.suspended=false}p.clearSelection=n;p.setSelection=h;p.getSelection=g;p.suspendSelection=d;p.resumeSelection=l;p.hooks.bindEvents.push(function(v,u){var w=v.getOptions();if(w.selection.mode!=null){u.mousemove(j);u.mousedown(i)}});p.hooks.drawOverlay.push(function(A,F){if(t.show&&s()){var v=A.getPlotOffset();var u=A.getOptions();F.save();F.translate(v.left,v.top);var B=a.color.parse(u.selection.color);F.strokeStyle=B.scale("a",0.8).toString();F.lineWidth=1;F.lineJoin=u.selection.shape;F.fillStyle=B.scale("a",0.4).toString();var D=Math.min(t.first.x,t.second.x)+0.5,C=Math.min(t.first.y,t.second.y)+0.5,E=Math.abs(t.second.x-t.first.x)-1,z=Math.abs(t.second.y-t.first.y)-1;F.fillRect(D,C,E,z);F.strokeRect(D,C,E,z);F.restore()}});p.hooks.shutdown.push(function(v,u){u.unbind("mousemove",j);u.unbind("mousedown",i);if(o){a(document).unbind("mouseup",o)}})}a.plot.plugins.push({init:b,options:{selection:{mode:null,color:"#e8cfac",shape:"round",minSize:5}},name:"selection",version:"1.1"})})(jQuery);